<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.system.mapper.SysUserMapper">

    <!-- 映射结果集：将 admin 表字段映射到 SysUser 对象 -->
    <resultMap type="com.ruoyi.system.api.domain.SysUser" id="SysUserResult">
        <id     property="userId"        column="id"              />
        <result property="userName"      column="username"        />
        <result property="nickName"      column="name"            />
        <result property="password"      column="password_hash"   />
        <result property="phonenumber"   column="phone"           />
        <result property="adminLevel"    column="admin_level"     />
        <result property="permissions"   column="permissions"     />
        <result property="status"        column="status"          />
        <result property="createTime"    column="created_at"      />
        <!-- 其他字段给默认值或空值，以兼容 SysUser 对象 -->
        <result property="delFlag"       column="del_flag"        />
        <result property="deptId"        column="dept_id"         />
    </resultMap>
	
    <!-- 基础查询列 -->
	<sql id="selectUserVo">
          select 
            id, 
            username, 
            name, 
            phone,
            admin_level,
            permissions,
            password_hash, 
            CASE WHEN is_active = 1 THEN '0' ELSE '1' END as status,
            created_at,
            '0' as del_flag,  -- 模拟未删除
            0 as dept_id      -- 模拟无部门
        from admin
    </sql>
    
    <!-- 根据用户名查询用户 (登录核心逻辑) -->
	<select id="selectUserByUserName" parameterType="String" resultMap="SysUserResult">
	    <include refid="selectUserVo"/>
		where username = #{userName} and is_deleted = 0
	</select>
	
    <!-- 根据ID查询用户 -->
	<select id="selectUserById" parameterType="Long" resultMap="SysUserResult">
		<include refid="selectUserVo"/>
		where id = #{userId} and is_deleted = 0
	</select>
	
    <!-- 查询用户列表 (管理端列表) -->
    <select id="selectUserList" parameterType="com.ruoyi.system.api.domain.SysUser" resultMap="SysUserResult">
    		select 
                id, 
                username, 
                name, 
                phone,
                admin_level,
                permissions,
                CASE WHEN is_active = 1 THEN '0' ELSE '1' END as status,
            created_at,
            '0' as del_flag,
            0 as dept_id
        from admin
		<where>
            <if test="params.includeDeleted == null or params.includeDeleted == '' or params.includeDeleted == 'false'">
                and is_deleted = 0
            </if>
            <if test="userName != null and userName != ''">
                AND username like concat('%', #{userName}, '%')
            </if>
            <if test="nickName != null and nickName != ''">
                AND name like concat('%', #{nickName}, '%')
            </if>
        </where>
	</select>
	
    <!-- 校验用户名唯一 -->
	<select id="checkUserNameUnique" parameterType="String" resultMap="SysUserResult">
		select id, username from admin where username = #{userName} and is_deleted = 0 limit 1
	</select>

    <!-- 校验手机号唯一 -->
    <select id="checkPhoneUnique" parameterType="String" resultMap="SysUserResult">
		select id, username, phone from admin where phone = #{phonenumber} and is_deleted = 0 limit 1
	</select>

    <!-- 校验Email唯一 (Admin无Email，返回空) -->
    <select id="checkEmailUnique" parameterType="String" resultMap="SysUserResult">
		select id, username from admin where 1=0
	</select>
	
    <!-- 新增用户 (适配 admin 表) -->
	<insert id="insertUser" parameterType="com.ruoyi.system.api.domain.SysUser" useGeneratedKeys="true" keyProperty="userId">
 		insert into admin(
  			<if test="userName != null and userName != ''">username,</if>
  			<if test="nickName != null and nickName != ''">name,</if>
             <if test="phonenumber != null and phonenumber != ''">phone,</if>
  			<if test="adminLevel != null">admin_level,</if>
  			<if test="permissions != null">permissions,</if>
  			<if test="password != null and password != ''">password_hash,</if>
  			<if test="status != null and status == '0'">is_active,</if>
             <if test="status != null and status == '1'">is_active,</if>
  			created_at
  		)values(
  			<if test="userName != null and userName != ''">#{userName},</if>
  			<if test="nickName != null and nickName != ''">#{nickName},</if>
             <if test="phonenumber != null and phonenumber != ''">#{phonenumber},</if>
             <if test="adminLevel != null">#{adminLevel},</if>
             <if test="permissions != null">#{permissions},</if>
  			<if test="password != null and password != ''">#{password},</if>
  			<if test="status != null and status == '0'">1,</if>
             <if test="status != null and status == '1'">0,</if>
  			sysdate()
  		)
	</insert>
	
    <!-- 修改用户 -->
	<update id="updateUser" parameterType="com.ruoyi.system.api.domain.SysUser">
 		update admin
 		<set>
  			<if test="nickName != null and nickName != ''">name = #{nickName},</if>
             <if test="phonenumber != null and phonenumber != ''">phone = #{phonenumber},</if>
             <if test="adminLevel != null">admin_level = #{adminLevel},</if>
             <if test="permissions != null">permissions = #{permissions},</if>
  			<if test="password != null and password != ''">password_hash = #{password},</if>
 			<if test="status != null and status == '0'">is_active = 1,</if>
            <if test="status != null and status == '1'">is_active = 0,</if>
 		</set>
 		where id = #{userId}
	</update>
    
    <!-- 更新登录信息 (admin表没有字段，不做操作) -->
  	<update id="updateLoginInfo" parameterType="com.ruoyi.system.api.domain.SysUser">
        update admin set id = id where id = #{userId}
	</update>

    <!-- 更新头像 (admin表没有字段，不做操作) -->
    <update id="updateUserAvatar">
        update admin set id = id where id = #{userId}
    </update>
	
    <!-- 重置密码 -->
	<update id="resetUserPwd" parameterType="com.ruoyi.system.api.domain.SysUser">
 		update admin set password_hash = #{password} where id = #{userId}
	</update>
	
    <!-- 删除用户 -->
	<update id="deleteUserById" parameterType="Long">
 		update admin set is_deleted = 1, deleted_at = sysdate() where id = #{userId}
 	</update>
 	
 	<update id="deleteUserByIds" parameterType="Long">
 		update admin set is_deleted = 1, deleted_at = sysdate() where id in
 		<foreach collection="array" item="userId" open="(" separator="," close=")">
 			#{userId}
        </foreach> 
 	</update>

    <!-- 根据角色ID查询已分配用户列表 -->
    <select id="selectAllocatedList" parameterType="com.ruoyi.system.api.domain.SysUser" resultMap="SysUserResult">
	    select distinct u.id, u.username, u.name, u.created_at,
            CASE WHEN u.is_active = 1 THEN '0' ELSE '1' END as status,
            '0' as del_flag, 0 as dept_id
	    from admin u
        <!--
	    left join sys_user_role ur on u.id = ur.user_id
	    left join sys_role r on r.role_id = ur.role_id
	    where u.is_active = 1 and r.role_id = #{roleId}
        -->
        where 1=0 -- 暂时禁用，因为没有角色关联表
	    <if test="userName != null and userName != ''">
			AND u.username like concat('%', #{userName}, '%')
		</if>
	</select>
	
    <!-- 根据角色ID查询未分配用户列表 -->
	<select id="selectUnallocatedList" parameterType="com.ruoyi.system.api.domain.SysUser" resultMap="SysUserResult">
	    select distinct u.id, u.username, u.name, u.created_at,
            CASE WHEN u.is_active = 1 THEN '0' ELSE '1' END as status,
            '0' as del_flag, 0 as dept_id
	    from admin u
        <!--
	    left join sys_user_role ur on u.id = ur.user_id
	    left join sys_role r on r.role_id = ur.role_id
	    where u.is_active = 1 and (r.role_id != #{roleId} or r.role_id IS NULL)
	    and u.id not in (select u.id from admin u inner join sys_user_role ur on u.id = ur.user_id and ur.role_id = #{roleId})
        -->
        where 1=0 -- 暂时禁用
	    <if test="userName != null and userName != ''">
			AND u.username like concat('%', #{userName}, '%')
		</if>
	</select>
	
</mapper>